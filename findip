#!/usr/bin/python3

import requests
import ipaddress
import subprocess
import json
import sys
import os

CONFIG_DIR = os.path.expanduser("~/.config")
BLOCKLIST_FILE = os.path.join(CONFIG_DIR, "blocked_ips.txt")

if not os.path.exists(CONFIG_DIR):
    os.makedirs(CONFIG_DIR)

def get_public_ip():
    return subprocess.check_output(["curl", "-s", "ifconfig.me"]).decode().strip()

def get_available_ips(subnet):
    url = f"http://steel.envy.ink:58212/api/{subnet}"
    response = requests.get(url)
    return [ip.strip() for ip in response.text.strip().splitlines() if ip.strip()]

def find_closest_ip(current_ip_str, available_ips, blocked_ips):
    current_ip = ipaddress.IPv4Address(current_ip_str)
    available = [ipaddress.IPv4Address(ip) for ip in available_ips if ip != current_ip_str and ip not in blocked_ips]
    if not available:
        return None
    closest = min(available, key=lambda ip: abs(int(ip) - int(current_ip)))
    return str(closest)

def get_default_gateway():
    route_output = subprocess.check_output(["ip", "route"]).decode()
    for line in route_output.splitlines():
        if line.startswith("default"):
            parts = line.split()
            if "via" in parts:
                return parts[parts.index("via") + 1]
    return None

def get_cidr_for_ip(target_ip):
    output = subprocess.check_output(["ip", "-j", "address"]).decode()
    data = json.loads(output)
    for iface in data:
        for addr in iface.get("addr_info", []):
            if addr.get("family") == "inet":
                if addr.get("local") == target_ip:
                    return addr.get("prefixlen")
    return None

def load_blocked_ips():
    if os.path.exists(BLOCKLIST_FILE):
        with open(BLOCKLIST_FILE) as f:
            return {line.strip() for line in f if line.strip()}
    return set()

def save_blocked_ip(ip):
    blocked = load_blocked_ips()
    blocked.add(ip)
    with open(BLOCKLIST_FILE, "w") as f:
        for b in blocked:
            f.write(b + "\n")

def main():
    show_all = "--all" in sys.argv
    block_arg = None

    if "--block" in sys.argv:
        try:
            block_arg = sys.argv[sys.argv.index("--block") + 1]
        except IndexError:
            print("Error: --block requires an IP address")
            return

    if block_arg:
        save_blocked_ip(block_arg)
        print(f"Blocked IP: {block_arg}")
        return

    current_ip = get_public_ip()
    prefixlen = get_cidr_for_ip(current_ip)
    if not prefixlen:
        return

    subnet = ".".join(current_ip.split(".")[:3]) + f".0/{prefixlen}"
    available_ips = get_available_ips(subnet)
    gateway = get_default_gateway()
    blocked_ips = load_blocked_ips()

    if show_all:
        print("usable ips:")
        for ip in available_ips:
            if ip not in blocked_ips:
                print(f"{ip}/{prefixlen}")
        if gateway:
            print(f"gateway: {gateway}")
            print("dns: 8.8.8.8, 8.8.4.4")
    else:
        chosen_ip = find_closest_ip(current_ip, available_ips, blocked_ips)
        if chosen_ip and gateway:
            print(f"ip: {chosen_ip}/{prefixlen}")
            print(f"gateway: {gateway}")
            print("dns: 8.8.8.8, 8.8.4.4")
        else:
            print("No available IP found (all may be blocked).")

if __name__ == "__main__":
    main()
